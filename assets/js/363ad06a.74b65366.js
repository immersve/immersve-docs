"use strict";(self.webpackChunkimmersve_docs=self.webpackChunkimmersve_docs||[]).push([[5945],{4992:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>i,default:()=>p,frontMatter:()=>l,metadata:()=>s,toc:()=>d});var a=n(7462),r=(n(7294),n(3905)),o=n(1839);const l={sidebar_position:2},i="MetaMask Integration",s={unversionedId:"guides/metamask-integration",id:"guides/metamask-integration",title:"MetaMask Integration",description:"Metamask integration walk-through",source:"@site/docs/guides/metamask-integration.md",sourceDirName:"guides",slug:"/guides/metamask-integration",permalink:"/guides/metamask-integration",draft:!1,tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"Authentication",permalink:"/guides/authentication"},next:{title:"API Reference",permalink:"/category/api-reference"}},u={},d=[{value:"User Flows",id:"user-flows",level:2},{value:"Login Flow",id:"login-flow",level:3},{value:"Payment Flow",id:"payment-flow",level:3},{value:"Generating Card",id:"generating-card",level:2},{value:"Getting Card Secure Details",id:"getting-card-secure-details",level:2},{value:"Cancel card",id:"cancel-card",level:2},{value:"Potential APIs",id:"potential-apis",level:3},{value:"TODO:",id:"todo",level:3}],c={toc:d};function p(e){let{components:t,...l}=e;return(0,r.kt)("wrapper",(0,a.Z)({},c,l,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"metamask-integration"},"MetaMask Integration"),(0,r.kt)("p",null,"Metamask integration walk-through"),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"User funding/login wallet (must be a USDC polygon wallet)")),(0,r.kt)("h2",{id:"user-flows"},"User Flows"),(0,r.kt)("h3",{id:"login-flow"},"Login Flow"),(0,r.kt)("p",null,"See ",(0,r.kt)("a",{parentName:"p",href:"/guides/authentication"},"authentication guide")),(0,r.kt)("h3",{id:"payment-flow"},"Payment Flow"),(0,r.kt)(o.G,{chart:"sequenceDiagram\n    autonumber\n    participant C as Customer\n    participant M as Metamask\n    participant I as Immersve\n    participant B as Blockchain\n    C->>M: Start Pay Metamask Plugin\n    C->>M: Set Amount and Currency\n    M->>I: Get Currency Conversion\n    I--\x3e>M: Return Currency Conversion in USDC\n    C->>M: Create Card Request\n\t\tM->>I: Pre Card Generation Validation\n\t\tI--\x3e>M: Pre Card Generation Validation Results\n    M--\x3e>C: Request Blockchain Transaction Approval\n\t\talt KYC required\n\t\tM--\x3e>C: Present QR Code to complete KYC\n\t\telse AML Soft Fail\n\t\tM--\x3e>C: Present QR Code to complete AML\n\t\telse AML Hard Fail\n\t\tM--\x3e>C: Show an error, this wallet cannot be used\n\t\tend\n    C->>M: Approve Transaction Request\n    M->>B: Submit Transaction\n    B--\x3e>M: Transaction Submitted\n\t\tM->>I: Create Card Request\n    activate I\n    I->>B: Check for Transaction to be Confirmed\n    B--\x3e>I: Transaction Confirmation\n    I--\x3e>I: Create VCC\n    I--\x3e>M: Customer Token\n\t\tdeactivate I\n\t\tnote right of M: Following record will have a different Authorization to maintain PCI compliance\n    M->>I: Retrieve Card Details\n    I--\x3e>M: Secure Card Details\n    M--\x3e>C: Present Card Details",mdxType:"Mermaid"}),(0,r.kt)("h2",{id:"generating-card"},"Generating Card"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Get list of currencies that we support for currency conversion call. Immersve should put cache control on this"),(0,r.kt)("li",{parentName:"ol"},"USDC to currency conversion (including estimated gas fee), this is estimate only:")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"GET /currency/convert"),"?target={targetCurrencySymbol}","\xa4","cy={sourceCurrencySymbol}&amount={amountToConvert}"),(0,r.kt)("p",null,"Response:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "sourceCurrency": "NZD",\n    "targetCurrency": "USDC",\n    "sourceAmount": 500,\n    "targetAmount": 320.22,\n    "expiresIn": "2022-01-01 00000 UTC", //TODO: check currency conversion API from Mastercard\n    "rate": 1.5,\n    "fees": [{\n            "type": "gas",\n            "amount": 2.50,\n            "currency": "USDC"\n        },\n        {\n            "type": "conversion_fee",\n            "amount": 5,\n            "currency": "NZD"\n        }\n    ]\n}\n')),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Check if new Card generation is allowed")),(0,r.kt)("p",null,"Sometimes, the creation of a new card won\u2019t be allowed:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"KYC is required"),(0,r.kt)("li",{parentName:"ul"},"AML hard reject (user wallets is black listed)"),(0,r.kt)("li",{parentName:"ul"},"AML soft reject (user needs to provide more details on the source of funds)")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"POST /card/generation-check")),(0,r.kt)("p",null,"Body:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "chainID": 137, // for now, just the Polygon network\n    "address": "0x3131232", // actual wallet where the user will pay from\n    "amount": {\n        "total": 320.22, // amount in USDC\n        "buffer": 0.1, // (optional) extra buffer to be sure that the transaction will go through\n        "currency": "USDC", // we will always use USDC, but we might want to use something else in the future, so this could be optional\n    },\n  "reference": "0asd3as21d" //TODO: check if we should send a reference back\n}\n')),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"200 - Response Successful")),(0,r.kt)("p",null,"User is allowed to generate a new card. Client should be able to request a transaction from the user wallet to Immersve wallet"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "status": "authorized",\n    "targetWallet": "0x031231", // Immersve wallet. This can be useful if we need to change the wallet in the future\n    "amount": { // authorized amount, anything higher than this will be rejected later (except for the buffer)\n        "total": 320.22, // amount in USDC\n        "buffer": 0.1, // (optional) extra buffer to be sure that the transaction will go through\n        "currency": "USDC", // we will always use USDC, but we might want to use something else in the future, so this could be optional\n    }\n}\n')),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"401 - Unauthorized")),(0,r.kt)("p",null,"User is not logged in, or the authentication token is expired. Will need to re-login"),(0,r.kt)("p",null,"Response:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "status": "unauthorized",\n    "reason": "NOT_LOGGED_IN",\n    "actionUrl": "https://immersve.com/user/web3/login" //TODO\n}\n')),(0,r.kt)("p",null,"403 - Forbidden operation //TODO: is 403 the right status code?"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"User needs KYC")),(0,r.kt)("p",null,"When the user reaches a certain amount spent in the platform, Immersve will require them to provide some identification information to comply with regulatory entities"),(0,r.kt)("p",null,"Response:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "status": "error",\n    "reason": "KYC_REQUIRED",\n    "actionUrl": "https://immersve.com/kyc/start?userId={immersve-userId}" //TODO\n}\n')),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"AML Checks Failed")),(0,r.kt)("p",null,"Immersve AML Provider found that the funding wallet might not comply with AML and can\u2019t check the origin of funds for the provided wallet. User will need to go through AML process to validate the source of the funds on the wallet"),(0,r.kt)("p",null,"TODO: define scenarios for hard and soft AML blocks"),(0,r.kt)("p",null,"Response:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "status": "error",\n    "reason": "AML_CHECK_FAILED", //TODO: do we want to reveal this\n    "actionUrl": "https://immersve.com/aml/start?userId={immersve-userId}&wallet={fundingWallet}" //TODO: anything we can do here?\n}\n')),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Generate new Card endpoint")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"POST /card/")),(0,r.kt)("p",null,"Body:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "source": "MetaMask", //MetaMask needs to ensure this is correct as this will be used to identify transactions triggered from MetaMask\n    "type": "vcc",\n    "amount": {\n        "total": 320.22, // amount in USDC\n        "buffer": 0.1, // (optional) extra buffer to be sure that the transaction will go through\n        "currency": "USDC", // we will always use USDC, but we might want to use something else in the future, so this could be optional\n    },\n    "transactionHash": "TODO: asdf", //for Immersve to check fund transfer on chain\n    "chainID": 123,\n    "returnSurplus": true, //indicate whether the suplus fund will be returned to the card holder\n}\n')),(0,r.kt)("p",null,"Note: Not part of MVP, but going forward we may add a wallet address as optional parameter in case wallet used to login is different from funding wallet. TODO, make the design flexible"),(0,r.kt)("p",null,"Response:"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"200 - Successful card creation")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "cardToken": "xyz", //the token used to fetch card details\n    "expiry": "2022-01-01 1111111UTC" //if a value that is earlier than the card expiry date on the card details, this value is when the card will actually expire instead of the expiry date on the card details\n}\n')),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"401 - Unauthorized")),(0,r.kt)("p",null,"User is not logged in, or the authentication token is expired. Will need to re-login"),(0,r.kt)("p",null,"Response:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "status": "unauthorized",\n    "reason": "NOT_LOGGED_IN",\n    "actionUrl": "https://immersve.com/user/web3/login" //TODO\n}\n')),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"403 - Forbidden operation")," //TODO: is 403 the right status code?"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"User needs KYC")),(0,r.kt)("p",null,"When the user reaches a certain amount spent in the platform, Immersve will require them to provide some identification information to comply with regulatory entities"),(0,r.kt)("p",null,"Response:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "status": "error",\n    "reason": "KYC_REQUIRED",\n    "actionUrl": "https://immersve.com/kyc/start?userId={immersve-userId}" //TODO\n}\n')),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"AML Checks Failed")),(0,r.kt)("p",null,"Immersve AML Provider found that the funding wallet might not comply with AML and can\u2019t check the origin of funds for the provided wallet. User will need to go through AML process to validate the source of the funds on the wallet"),(0,r.kt)("p",null,"TODO: define scenarios for hard and soft AML blocks"),(0,r.kt)("p",null,"Response:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "status": "error",\n    "reason": "AML_CHECK_FAILED", //TODO: do we want to reveal this\n    "actionUrl": "https://immersve.com/aml/start?userId={immersve-userId}&wallet={fundingWallet}" //TODO: anything we can do here?\n}\n')),(0,r.kt)("h2",{id:"getting-card-secure-details"},"Getting Card Secure Details"),(0,r.kt)("p",null,"Get ",(0,r.kt)("a",{parentName:"p",href:"http://external.immersve.com/cards/details"},"external.immersve.com/cards/details")," //TODO: decide URL"),(0,r.kt)("p",null,"For the purpose of filling in ecom payment page."),(0,r.kt)("p",null,"Response"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "cardNumber": "4111111111111111",\n    "cvv2": "123",\n    "expiry": "202706", \n    "name": "Immersve Mastercard"\n}\n')),(0,r.kt)("h2",{id:"cancel-card"},"Cancel card"),(0,r.kt)("p",null,"TODO"),(0,r.kt)("h3",{id:"potential-apis"},"Potential APIs"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"refresh tokens API")),(0,r.kt)("h3",{id:"todo"},"TODO:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"assumptions"),(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},"Currency conversion displays is estimation only"),(0,r.kt)("li",{parentName:"ol"},"allow anyone to transfer fund to Immersve wallet (what if there are funds that are not legit fund for generating cards?)"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"KYC/AML flows")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Edge cases "),(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},"around currency conversions"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Book security review with Marco"),(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},"Authentication"),(0,r.kt)("li",{parentName:"ol"},"Secure way to share Immersve wallet address with MetaMask"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Do we allow unintended deposit to Immersve wallet, for example"),(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},"a user trying to deposit an amount larger than what\u2019s allowed without KYC"),(0,r.kt)("li",{parentName:"ol"},"a hacker decided to deposit say 1b into Immersve wallet"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"to do"),(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"cases on surplus/buffer of fund transfer to Immersve wallet (default value for MVP?)"),(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},"how do we handle the transfer back to the user say when the amount of surplus is less than the gas fee that is required for transfer"),(0,r.kt)("li",{parentName:"ol"},"we need to keep track of those transfers and records and running totals"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"timing requirements on getting card details, 1 or 2 calls to E6 to get card token")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"currency conversion lock-in mechanism, or would the currency displayed just indication only (with disclaimer)"),(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"})),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{alt:"Untitled",src:n(3561).Z,width:"514",height:"466"})))))),(0,r.kt)("p",null,"What should happen in the case of timeout?"))}p.isMDXComponent=!0},3561:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/card-generated-47ab29a6a305d63897542252cd9b8991.png"}}]);