"use strict";(self.webpackChunkimmersve_docs=self.webpackChunkimmersve_docs||[]).push([[2277],{68560:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>d,contentTitle:()=>i,default:()=>m,frontMatter:()=>l,metadata:()=>s,toc:()=>p});var n=a(87462),o=(a(67294),a(3905)),r=a(8209);const l={sidebar_position:1,tags:["payment","protocol","lock","settle","funds","card","e-commerce","purchase","asset","assetlockedfund","expiration","safety","threshold","settler","deposit","withdraw","confirm-payment","balance"]},i="Immersve Payment Protocol",s={unversionedId:"contracts/payment-protocol",id:"contracts/payment-protocol",title:"Immersve Payment Protocol",description:"Contract Module that allows users to deposit and lock funds in order to be able to fund one-time-use Immersve virtual cards.",source:"@site/docs/contracts/payment-protocol.md",sourceDirName:"contracts",slug:"/contracts/payment-protocol",permalink:"/contracts/payment-protocol",draft:!1,tags:[{label:"payment",permalink:"/tags/payment"},{label:"protocol",permalink:"/tags/protocol"},{label:"lock",permalink:"/tags/lock"},{label:"settle",permalink:"/tags/settle"},{label:"funds",permalink:"/tags/funds"},{label:"card",permalink:"/tags/card"},{label:"e-commerce",permalink:"/tags/e-commerce"},{label:"purchase",permalink:"/tags/purchase"},{label:"asset",permalink:"/tags/asset"},{label:"assetlockedfund",permalink:"/tags/assetlockedfund"},{label:"expiration",permalink:"/tags/expiration"},{label:"safety",permalink:"/tags/safety"},{label:"threshold",permalink:"/tags/threshold"},{label:"settler",permalink:"/tags/settler"},{label:"deposit",permalink:"/tags/deposit"},{label:"withdraw",permalink:"/tags/withdraw"},{label:"confirm-payment",permalink:"/tags/confirm-payment"},{label:"balance",permalink:"/tags/balance"}],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1,tags:["payment","protocol","lock","settle","funds","card","e-commerce","purchase","asset","assetlockedfund","expiration","safety","threshold","settler","deposit","withdraw","confirm-payment","balance"]},sidebar:"primarySidebar",previous:{title:"Reverse a transaction",permalink:"/api-reference/reverse-a-transaction"}},d={},p=[{value:"Proxy URLs",id:"proxy-urls",level:2},{value:"Extensions",id:"extensions",level:2},{value:"Proxy",id:"proxy",level:2},{value:"Functions",id:"functions",level:2},{value:"<code>withdraw</code>(uint <code>_amount</code>) <code>external</code> nonReentrant notZeroValue(<code>_amount</code>) whenNotPaused",id:"withdrawuint-_amount-external-nonreentrant-notzerovalue_amount-whennotpaused",level:3},{value:"<code>depositAndLock</code>(uint <code>_amount</code>) <code>external</code> nonReentrant notZeroValue(<code>_amount</code>) whenNotPaused",id:"depositandlockuint-_amount-external-nonreentrant-notzerovalue_amount-whennotpaused",level:3},{value:"<code>extendLockedFund</code>() <code>external</code> whenNotPaused",id:"extendlockedfund-external-whennotpaused",level:3},{value:"<code>getTimeoutHasPassed</code> (address _address, uint _additionalBlocks) public view returns (bool)",id:"gettimeouthaspassed-address-_address-uint-_additionalblocks-public-view-returns-bool",level:3},{value:"Response",id:"response",level:4},{value:"<code>getLockedFundBalance</code> (address _address, uint _additionalBlocks) public view returns (bool, uint)",id:"getlockedfundbalance-address-_address-uint-_additionalblocks-public-view-returns-bool-uint",level:3},{value:"Response",id:"response-1",level:4},{value:"Immersve Card E-Commerce Payment Happy Path",id:"immersve-card-e-commerce-payment-happy-path",level:2}],c={toc:p};function m(e){let{components:t,...a}=e;return(0,o.kt)("wrapper",(0,n.Z)({},c,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"immersve-payment-protocol"},"Immersve Payment Protocol"),(0,o.kt)("p",null,"Contract Module that allows users to deposit and lock funds in order to be able to fund one-time-use Immersve virtual cards."),(0,o.kt)("h2",{id:"proxy-urls"},"Proxy URLs"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Polygon USDC (Mainnet): ",(0,o.kt)("strong",{parentName:"li"},(0,o.kt)("em",{parentName:"strong"},"PENDING"))),(0,o.kt)("li",{parentName:"ul"},"Polygon Mumbai USDC (Testnet): ",(0,o.kt)("a",{parentName:"li",href:"https://mumbai.polygonscan.com/address/0x91a4ee183763d9fd67F878abCCfFb2D6E51433eA#writeProxyContract"},"0x91a4ee183763d9fd67F878abCCfFb2D6E51433eA"))),(0,o.kt)("h2",{id:"extensions"},"Extensions"),(0,o.kt)("p",null,"For security reasons, the smart contract implements the following ",(0,o.kt)("a",{parentName:"p",href:"https://docs.openzeppelin.com/contracts/4.x/"},"OpenZeppelin Contracts")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.openzeppelin.com/contracts/4.x/api/proxy#Initializable"},"Initializable")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.openzeppelin.com/contracts/4.x/api/access#AccessControl"},"AccessControl")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.openzeppelin.com/contracts/4.x/api/security#Pausable"},"Pausable")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.openzeppelin.com/contracts/4.x/api/security#ReentrancyGuard"},"ReentrancyGuard"))),(0,o.kt)("h2",{id:"proxy"},"Proxy"),(0,o.kt)("p",null,"The Smart Contract implements the OpenZeppelin ",(0,o.kt)("a",{parentName:"p",href:"https://docs.openzeppelin.com/contracts/4.x/api/proxy#TransparentUpgradeableProxy"},"TransparentUpgradeable")," proxy. Proxy features:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Security"),": If any bugs are found, or potential security risks, the Smart Contract can be updated to resolve any potential issues"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Feature Upgradeability"),": Any new features and bug fixes can be added. The Smart Contract will keep the same state, without the need of expensive migrations"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Stability"),": Clients interacting with the Smart Contract will always do so through the same proxy address. The proxy will know the current implementation address and will always keep the same state.")),(0,o.kt)("p",null,"More about upgradeable contracts here: ",(0,o.kt)("a",{parentName:"p",href:"https://blog.openzeppelin.com/the-state-of-smart-contract-upgrades/"},"https://blog.openzeppelin.com/the-state-of-smart-contract-upgrades/")),(0,o.kt)(r.G,{chart:'graph LR\n    Client -- Trx --\x3e Proxy[(Proxy)]\n    Proxy -- "getImplementation()" --\x3e Proxy\n    Proxy -- old --\x3e v1{{ContractImplV1}}\n    Proxy -- "delegate call" --\x3e v2{{ContractImplV2}}',mdxType:"Mermaid"}),(0,o.kt)("h2",{id:"functions"},"Functions"),(0,o.kt)("h3",{id:"withdrawuint-_amount-external-nonreentrant-notzerovalue_amount-whennotpaused"},(0,o.kt)("inlineCode",{parentName:"h3"},"withdraw"),"(uint ",(0,o.kt)("inlineCode",{parentName:"h3"},"_amount"),") ",(0,o.kt)("inlineCode",{parentName:"h3"},"external")," nonReentrant notZeroValue(",(0,o.kt)("inlineCode",{parentName:"h3"},"_amount"),") whenNotPaused"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"CardHolders can withdraw token funds associated to their balance from the Smart Contract using this function. Locked funds cannot be withdrawn until the lock expires, or Immersve revokes the lock."),(0,o.kt)("ul",{parentName:"blockquote"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"tokenAmount")," (type ",(0,o.kt)("inlineCode",{parentName:"li"},"uint"),"): token Amount to withdraw in minor units"))),(0,o.kt)("hr",null),(0,o.kt)("h3",{id:"depositandlockuint-_amount-external-nonreentrant-notzerovalue_amount-whennotpaused"},(0,o.kt)("inlineCode",{parentName:"h3"},"depositAndLock"),"(uint ",(0,o.kt)("inlineCode",{parentName:"h3"},"_amount"),") ",(0,o.kt)("inlineCode",{parentName:"h3"},"external")," nonReentrant notZeroValue(",(0,o.kt)("inlineCode",{parentName:"h3"},"_amount"),") whenNotPaused"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"CardHolders can deposit an amount of funds and lock it immediately. This will lock the funds for a number of blocks specified by the ",(0,o.kt)("inlineCode",{parentName:"p"},"timeoutBlocks")," property of the smart contract."),(0,o.kt)("ul",{parentName:"blockquote"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"_amount")," (type ",(0,o.kt)("inlineCode",{parentName:"li"},"uint"),"): token Amount to deposit in minor units"))),(0,o.kt)("hr",null),(0,o.kt)("h3",{id:"extendlockedfund-external-whennotpaused"},(0,o.kt)("inlineCode",{parentName:"h3"},"extendLockedFund"),"() ",(0,o.kt)("inlineCode",{parentName:"h3"},"external")," whenNotPaused"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"Allows user to extend his own lock. This operation will fail if there are no locked funds for the wallet initiating the transaction")),(0,o.kt)("hr",null),(0,o.kt)("h3",{id:"gettimeouthaspassed-address-_address-uint-_additionalblocks-public-view-returns-bool"},(0,o.kt)("inlineCode",{parentName:"h3"},"getTimeoutHasPassed")," (address _address, uint _additionalBlocks) public view returns (bool)"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"Retrieves whether the timeout has passed for the lock owned by the ",(0,o.kt)("inlineCode",{parentName:"p"},"_address"),".")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"_address")," (type ",(0,o.kt)("inlineCode",{parentName:"li"},"address"),"): CardHolder Address"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"_additionalBlocks")," (type ",(0,o.kt)("inlineCode",{parentName:"li"},"uint"),"): Optional argument to calculate expiration of a locked fund based on an extra amount of blocks")),(0,o.kt)("h4",{id:"response"},"Response"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"bool"),": ",(0,o.kt)("inlineCode",{parentName:"p"},"true")," if the timeout of the block for ",(0,o.kt)("inlineCode",{parentName:"p"},"_address")," has passed, ",(0,o.kt)("inlineCode",{parentName:"p"},"false")," if the lock is still active"),(0,o.kt)("hr",null),(0,o.kt)("h3",{id:"getlockedfundbalance-address-_address-uint-_additionalblocks-public-view-returns-bool-uint"},(0,o.kt)("inlineCode",{parentName:"h3"},"getLockedFundBalance")," (address _address, uint _additionalBlocks) public view returns (bool, uint)"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"Retrieves whether the timeout has passed for the lock owned by the ",(0,o.kt)("inlineCode",{parentName:"p"},"_address"),". Similar to ",(0,o.kt)("a",{parentName:"p",href:"/contracts/payment-protocol#gettimeouthaspassed-address-_address-uint-_additionalblocks-public-view-returns-bool"},"getTimeoutHasPassed")," but it returns an array indicating if the timeout has passed and the actual balance of the lock for the specified address")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"_address")," (type ",(0,o.kt)("inlineCode",{parentName:"li"},"address"),"): CardHolder Address"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"_additionalBlocks")," (type ",(0,o.kt)("inlineCode",{parentName:"li"},"uint"),"): Optional argument to calculate expiration of a locked fund based on an extra amount of blocks")),(0,o.kt)("h4",{id:"response-1"},"Response"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"array"),": "),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"0 ",(0,o.kt)("inlineCode",{parentName:"li"},"timeoutHasPassed")," (type ",(0,o.kt)("inlineCode",{parentName:"li"},"bool"),"): ",(0,o.kt)("inlineCode",{parentName:"li"},"true")," if the timeout of the block for ",(0,o.kt)("inlineCode",{parentName:"li"},"_address")," has passed, ",(0,o.kt)("inlineCode",{parentName:"li"},"false")," if the lock is still active"),(0,o.kt)("li",{parentName:"ul"},"1 ",(0,o.kt)("inlineCode",{parentName:"li"},"lockedFundBalance")," (type ",(0,o.kt)("inlineCode",{parentName:"li"},"uint"),"): the balance of the locked fund for the specified address")),(0,o.kt)("hr",null),(0,o.kt)("h2",{id:"immersve-card-e-commerce-payment-happy-path"},"Immersve Card E-Commerce Payment Happy Path"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Card Holder locks token funds with Immersve Smart Contract"),(0,o.kt)("li",{parentName:"ul"},"Card Holder receives a valid Credit Card to be used for E-Commerce transaction from Immersve"),(0,o.kt)("li",{parentName:"ul"},"Card Holder uses the Immersve Card to pay for goods purchased on an E-Commerce platform"),(0,o.kt)("li",{parentName:"ul"},"Immersve authorizes the payment with Credit Card network once the locked funds are confirmed"),(0,o.kt)("li",{parentName:"ul"},"Purchase is confirmed by Immersve and E-Commerce merchant")),(0,o.kt)(r.G,{chart:"sequenceDiagram\n    participant H as Card Holder\n    participant W as Web3 Wallet\n    participant I as Immersve Backend\n    participant S as Smart Contract\n    participant U as token Smart Contract\n    participant E as E-Commerce website\n    participant M as E-Commerce Merchant\n    H->>I: Create card pre-request\n    I--\x3e>H: Web3 Transaction Details\n    H->>W: Submit Transactions\n    W->>U: Approve Card Total Authorized Amount in token\n    W->>S: Deposit and Lock token funds\n    S->>U: Transfer approved amount from Card Holder wallet to Immersve Smart Contract\n    S--\x3e>S: Add approved amount to Card Holder address balance\n    S--\x3e>S: Create LockedFund to temporarily lock Card Holder funds to be used by Immersve Card\n    S--\x3e>W: Transaction Hash\n    W--\x3e>H: Transaction Hash\n    H->>I: Card Create Request\n    I->>S: Check enough funds for Card creation\n    S--\x3e>I: Locked Funds confirmed\n    I--\x3e>H: Card created\n    H->>E: Use Immersve Card to pay for goods online\n    E--\x3e>M: Validate Credit Card payment\n    M->>I: Merchant request payment authorization through Credit Card network\n    I->>S: Check locked funds and settle payment amount\n    S->>S: Settle payment funds\n    I->>M: Authorize payment",mdxType:"Mermaid"}))}m.isMDXComponent=!0}}]);